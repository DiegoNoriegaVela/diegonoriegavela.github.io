import java.io.*;
import java.util.*;

public class IsoLogConverter {
    
    public static void main(String[] args) {
        if (args.length < 2) {
            System.out.println("Uso: java IsoLogConverter --input <ruta_archivo>");
            return;
        }
        
        String inputPath = args[1];
        convertFile(inputPath);
    }
    
    public static void convertFile(String inputPath) {
        try {
            BufferedReader reader = new BufferedReader(new FileReader(inputPath));
            String outputPath = inputPath.replaceAll("(\\.[^.]+)?$", ".binary");
            FileOutputStream fos = new FileOutputStream(outputPath);
            
            String line;
            int lineNum = 0;
            
            while ((line = reader.readLine()) != null) {
                lineNum++;
                
                // Línea 2 es el bitmap (después del MTI)
                if (lineNum == 2) {
                    // Convertir bitmap de formato especial a hex binario
                    byte[] bitmapBytes = convertBitmapToBinary(line.trim());
                    fos.write(bitmapBytes);
                } else {
                    // Escribir otras líneas tal cual
                    fos.write(line.getBytes("ISO-8859-1"));
                }
                
                fos.write('\n');
            }
            
            reader.close();
            fos.close();
            
            System.out.println("Conversión exitosa: " + outputPath);
            
        } catch (IOException e) {
            System.err.println("Error: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    private static byte[] convertBitmapToBinary(String bitmapStr) {
        // El bitmap viene como string de 36 caracteres
        // Necesitamos convertirlo a 16 bytes hex
        
        // Primero, identificar el formato correcto
        // Si son 36 chars, tomar grupos de formato específico
        
        // Basándome en el ejemplo: 8000001000001000000200000000000000
        // Esto parece ser un formato propietario o BCD
        
        // Por ahora, si tiene 32+ caracteres hex válidos, convertir
        if (bitmapStr.length() >= 32 && isAllHex(bitmapStr.substring(0, 32))) {
            return hexToBytes(bitmapStr.substring(0, 32));
        }
        
        // Si no, retornar como está
        return bitmapStr.getBytes();
    }
    
    private static boolean isAllHex(String str) {
        for (char c : str.toCharArray()) {
            if (!isHexChar(c)) {
                return false;
            }
        }
        return true;
    }
    
    private static boolean isHexChar(char c) {
        return (c >= '0' && c <= '9') || 
               (c >= 'A' && c <= 'F') || 
               (c >= 'a' && c <= 'f');
    }
    
    private static byte[] hexToBytes(String hex) {
        int len = hex.length();
        byte[] bytes = new byte[len / 2];
        
        for (int i = 0; i < len; i += 2) {
            bytes[i / 2] = (byte) ((Character.digit(hex.charAt(i), 16) << 4)
                                 + Character.digit(hex.charAt(i+1), 16));
        }
        
        return bytes;
    }
}
