import java.io.*;
import java.nio.charset.StandardCharsets;

public class IsoRawConverter {

    public static void main(String[] args) {
        String inputPath = null;

        // Leer argumento --input
        for (int i = 0; i < args.length; i++) {
            if ("--input".equals(args[i]) && i + 1 < args.length) {
                inputPath = args[i + 1];
            }
        }

        if (inputPath == null) {
            System.err.println("âŒ Error: Indica el archivo con --input");
            System.err.println("Ejemplo: java IsoRawConverter --input \"Ruta/Del/Archivo\"");
            return;
        }

        String outputPath = inputPath + "_BINARIO_EXPANDIDO.txt";
        System.out.println("ðŸ”„ Procesando trama con Bitmap Binario (Raw)...");

        // USAMOS ISO_8859_1: Fundamental para leer los bytes "raros" tal cual son (1 byte = 1 char)
        try (BufferedReader br = new BufferedReader(new InputStreamReader(new FileInputStream(inputPath), StandardCharsets.ISO_8859_1));
             BufferedWriter bw = new BufferedWriter(new FileWriter(outputPath))) {

            String line;
            int contador = 0;

            while ((line = br.readLine()) != null) {
                contador++;
                // ValidaciÃ³n mÃ­nima: MTI (4) + Bitmap Raw (16) = 20 chars mÃ­nimo
                if (line.length() < 20) {
                    bw.write(line); 
                    bw.newLine(); 
                    continue; 
                }

                try {
                    // 1. MTI: Primeros 4 caracteres (ej: 1644, 1240)
                    String mti = line.substring(0, 4);

                    // 2. BITMAP ORIGINAL (RAW): Tomamos los siguientes 16 caracteres exactos
                    // Aunque parezcan sÃ­mbolos raros (Ãƒ, ~, cuadros), son los datos reales.
                    String bitmapRaw = line.substring(4, 20);

                    // 3. RESTO: Todo lo que sigue despuÃ©s del byte 20
                    String restoTrama = line.substring(20);

                    // 4. CONVERSIÃ“N: Expandimos esos 16 bytes a 128 unos y ceros
                    String bitmapBinario = rawToBinario(bitmapRaw);

                    // 5. GUARDAR: MTI + [128 bits visuales] + Resto
                    bw.write(mti + bitmapBinario + restoTrama);
                    bw.newLine();

                } catch (Exception e) {
                    System.err.println("âš ï¸ Alerta en lÃ­nea " + contador + ": " + e.getMessage());
                    bw.write(line); // Copiamos original si hay error
                    bw.newLine();
                }
            }
            System.out.println("âœ… Â¡Listo! Archivo generado: " + outputPath);

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    /**
     * Toma una cadena de caracteres "raw" (bytes crudos).
     * Convierte cada caracter a su representaciÃ³n de 8 bits.
     * 16 chars de entrada -> 128 chars de salida (0s y 1s).
     */
    private static String rawToBinario(String raw) {
        StringBuilder sb = new StringBuilder();
        for (char c : raw.toCharArray()) {
            // Obtenemos el valor del byte (0 a 255)
            int valorByte = c & 0xFF;
            
            // Convertimos a string binario (ej: "1100")
            String bin = Integer.toBinaryString(valorByte);
            
            // Rellenamos con ceros a la izquierda para asegurar 8 bits por byte
            // Ej: "11" -> "00000011"
            while (bin.length() < 8) {
                bin = "0" + bin;
            }
            sb.append(bin);
        }
        return sb.toString();
    }
}
