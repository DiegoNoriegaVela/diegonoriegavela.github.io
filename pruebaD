import java.io.*;
import java.nio.file.*;

public class IsoLogConverter {
    
    public static void main(String[] args) {
        if (args.length < 2) {
            System.out.println("Uso: java IsoLogConverter --input <ruta_archivo>");
            return;
        }
        
        String inputPath = args[1];
        convertFile(inputPath);
    }
    
    public static void convertFile(String inputPath) {
        try {
            // Leer el archivo original
            Path path = Paths.get(inputPath);
            List<String> lines = Files.readAllLines(path);
            
            // Crear archivo de salida
            String outputPath = inputPath.replaceAll("(\\.[^.]+)?$", ".binary");
            FileOutputStream fos = new FileOutputStream(outputPath);
            
            for (String line : lines) {
                if (line.length() >= 36) {
                    // MTI: primeros 4 caracteres
                    String mti = line.substring(0, 4);
                    
                    // Bitmap: siguientes 32 caracteres en hex
                    String bitmapHex = line.substring(4, 36);
                    
                    // Resto de la línea
                    String resto = line.substring(36);
                    
                    // Escribir MTI en ASCII
                    fos.write(mti.getBytes("ISO-8859-1"));
                    
                    // Convertir y escribir bitmap como bytes binarios
                    byte[] bitmapBytes = hexToBytes(bitmapHex);
                    fos.write(bitmapBytes);
                    
                    // Escribir el resto en ASCII
                    fos.write(resto.getBytes("ISO-8859-1"));
                    fos.write('\n');
                    
                } else {
                    // Línea corta, escribir tal cual
                    fos.write(line.getBytes("ISO-8859-1"));
                    fos.write('\n');
                }
            }
            
            fos.close();
            System.out.println("Archivo convertido exitosamente: " + outputPath);
            
        } catch (IOException e) {
            System.err.println("Error procesando archivo: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    // Convierte string hexadecimal a bytes
    private static byte[] hexToBytes(String hex) {
        int len = hex.length();
        byte[] bytes = new byte[len / 2];
        
        for (int i = 0; i < len; i += 2) {
            bytes[i / 2] = (byte) ((Character.digit(hex.charAt(i), 16) << 4)
                                 + Character.digit(hex.charAt(i+1), 16));
        }
        
        return bytes;
    }
}
