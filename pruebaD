import java.io.BufferedReader;
import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileInputStream; // Nuevo import para compatibilidad
import java.io.FileOutputStream;
import java.io.InputStreamReader; // Nuevo import para compatibilidad
import java.io.IOException;
// Eliminamos StandardCharsets para máxima compatibilidad con Java 6/7/8

public class IsoBitmapHexToBinaryConverter {

    private static final int MTI_LENGTH = 4;
    private static final int BITMAP_HEX_LENGTH = 32; 
    private static final int TOTAL_PREFIX_LENGTH = MTI_LENGTH + BITMAP_HEX_LENGTH;

    public static void main(String[] args) {
        String inputFileBasePath = null;
        String outputFileBasePath = null;

        for (int i = 0; i < args.length; i++) {
            if ("--input".equals(args[i]) && i + 1 < args.length) {
                inputFileBasePath = args[i + 1];
                i++;
            } else if ("--output".equals(args[i]) && i + 1 < args.length) {
                outputFileBasePath = args[i + 1];
                i++;
            }
        }

        if (inputFileBasePath == null || outputFileBasePath == null) {
            System.err.println("Error: Faltan parametros.");
            System.err.println("Uso: java IsoBitmapHexToBinaryConverter --input <origen> --output <destino>");
            System.exit(1);
        }

        File inputFile = new File(inputFileBasePath);
        File outputFile = new File(outputFileBasePath);

        if (!inputFile.exists() || !inputFile.isFile()) {
            System.err.println("Error: El archivo de entrada no existe: " + inputFileBasePath);
            System.exit(1);
        }

        System.out.println("Procesando en AS/400...");
        System.out.println("In: " + inputFile.getAbsolutePath());
        System.out.println("Out: " + outputFile.getAbsolutePath());

        // CAMBIO PRINCIPAL AQUI:
        // Usamos FileInputStream + InputStreamReader en lugar de FileReader.
        // Esto funciona en Java 7, 8 y versiones antiguas del AS/400.
        BufferedReader reader = null;
        BufferedOutputStream writer = null;

        try {
            // Forzamos la lectura en US-ASCII para evitar problemas de EBCDIC en el AS400
            reader = new BufferedReader(new InputStreamReader(new FileInputStream(inputFile), "US-ASCII"));
            writer = new BufferedOutputStream(new FileOutputStream(outputFile));

            String line;
            int lineNumber = 0;
            int processedCount = 0;

            while ((line = reader.readLine()) != null) {
                lineNumber++;

                if (line.length() < TOTAL_PREFIX_LENGTH) {
                    System.err.println("Linea " + lineNumber + " muy corta, omitida.");
                    continue;
                }

                try {
                    String mtiStr = line.substring(0, MTI_LENGTH);
                    String hexBitmapStr = line.substring(MTI_LENGTH, TOTAL_PREFIX_LENGTH);
                    String restOfDataStr = line.substring(TOTAL_PREFIX_LENGTH);

                    byte[] binaryBitmap = hexStringToByteArray(hexBitmapStr);

                    // Escribir MTI
                    writer.write(mtiStr.getBytes("US-ASCII"));

                    // Escribir Bitmap BINARIO
                    writer.write(binaryBitmap);

                    // Escribir el resto
                    writer.write(restOfDataStr.getBytes("US-ASCII"));
                    
                    // Salto de línea
                    writer.write('\n');

                    processedCount++;

                } catch (IllegalArgumentException e) {
                    System.err.println("Error linea " + lineNumber + ": Bitmap invalido.");
                } catch (Exception e) {
                     System.err.println("Error procesando linea " + lineNumber);
                }
            }
            
            writer.flush();
            System.out.println("Fin. Total procesados: " + processedCount);

        } catch (IOException e) {
            System.err.println("Error de E/S: " + e.getMessage());
            e.printStackTrace();
        } finally {
            // Bloque finally para cerrar recursos de forma segura en Java antiguo
            try {
                if (reader != null) reader.close();
                if (writer != null) writer.close();
            } catch (IOException ex) {
                ex.printStackTrace();
            }
        }
    }

    private static byte[] hexStringToByteArray(String s) {
        int len = s.length();
        if (len % 2 != 0) {
             throw new IllegalArgumentException("Longitud impar");
        }
        byte[] data = new byte[len / 2];
        for (int i = 0; i < len; i += 2) {
            int digit1 = Character.digit(s.charAt(i), 16);
            int digit2 = Character.digit(s.charAt(i + 1), 16);
            if (digit1 == -1 || digit2 == -1) {
                 throw new IllegalArgumentException("Caracter no hex");
            }
            data[i / 2] = (byte) ((digit1 << 4) + digit2);
        }
        return data;
    }
}
