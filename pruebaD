import java.io.*;
import java.nio.file.*;

public class IsoLogConverter {
    
    public static void main(String[] args) {
        if (args.length < 2) {
            System.out.println("Uso: java IsoLogConverter --input <ruta_archivo>");
            return;
        }
        
        String inputPath = args[1];
        convertFile(inputPath);
    }
    
    public static void convertFile(String inputPath) {
        BufferedReader reader = null;
        FileOutputStream fos = null;
        
        try {
            // Archivo de entrada
            reader = new BufferedReader(new FileReader(inputPath));
            
            // Archivo de salida
            String outputPath = inputPath.replaceAll("(\\.[^.]+)?$", ".binary");
            fos = new FileOutputStream(outputPath);
            
            String line;
            while ((line = reader.readLine()) != null) {
                // Procesar solo si la línea tiene al menos MTI (4) + Bitmap (32) = 36 caracteres
                if (line.length() >= 36) {
                    // MTI: primeros 4 caracteres
                    String mti = line.substring(0, 4);
                    
                    // Bitmap: siguientes 32 caracteres (en hexadecimal)
                    String bitmapHex = line.substring(4, 36);
                    
                    // Resto de la línea (sin modificar)
                    String resto = line.length() > 36 ? line.substring(36) : "";
                    
                    // Escribir MTI
                    fos.write(mti.getBytes("ISO-8859-1"));
                    
                    // Convertir bitmap hex a binario y escribir
                    byte[] bitmapBinary = hexToBytes(bitmapHex);
                    fos.write(bitmapBinary);
                    
                    // Escribir el resto
                    fos.write(resto.getBytes("ISO-8859-1"));
                    
                } else {
                    // Línea muy corta, escribir tal cual
                    fos.write(line.getBytes("ISO-8859-1"));
                }
                
                // Salto de línea
                fos.write('\n');
            }
            
            System.out.println("Conversión exitosa: " + outputPath);
            
        } catch (IOException e) {
            System.err.println("Error: " + e.getMessage());
            e.printStackTrace();
        } finally {
            try {
                if (reader != null) reader.close();
                if (fos != null) fos.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
    
    private static byte[] hexToBytes(String hex) {
        int len = hex.length();
        byte[] bytes = new byte[len / 2];
        
        for (int i = 0; i < len; i += 2) {
            bytes[i / 2] = (byte) ((Character.digit(hex.charAt(i), 16) << 4)
                                 + Character.digit(hex.charAt(i+1), 16));
        }
        
        return bytes;
    }
}
