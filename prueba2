/**
 * Convierte archivo IPM a ASCII usando IpmConverter y aplica formateo de reporte
 * Detecta automaticamente si usar decodeipm o decode
 */
private static void convertIpmToAscii(String inputIpm, String finalOutputFile, 
        String headerName, String fileName, boolean debugMode) throws Exception {
    
    boolean isIpmWithRdw = isIpmFileType(fileName);
    
    if (DEBUG || debugMode) {
        System.out.println("DEBUG: Tipo de archivo: " + 
            (isIpmWithRdw ? "IPM con RDW" : "EBCDIC plano"));
    }

    File tempAsciiFile = null;
    try {
        // 1. Crear archivo temporal para salida de conversion
        tempAsciiFile = File.createTempFile("decoded_ascii_", ".txt");
        if (DEBUG || debugMode) {
            System.out.println("DEBUG: Temporal ASCII (sin formatear): " + tempAsciiFile.getAbsolutePath());
        }

        // 2. Ejecutar conversion EBCDIC -> ASCII
        if (isIpmWithRdw) {
            IpmConverter.runDecodeIpm(inputIpm, tempAsciiFile.getAbsolutePath());
        } else {
            IpmConverter.runDecode(inputIpm, tempAsciiFile.getAbsolutePath());
        }
        
        System.out.println("Decodificacion completada");

        // 3. Aplicar formateo de reporte (incluye header y reglas específicas)
        System.out.println("Aplicando formateo de reporte...");
        
        // Obtener descripción del formateo
        String formattingDesc = MipReportFormatter.getFormattingDescription(headerName);
        if (DEBUG || debugMode) {
            System.out.println("DEBUG: Formato: " + formattingDesc);
        }
        
        // Aplicar formateo según tipo de reporte
        MipReportFormatter.formatReport(headerName, tempAsciiFile, finalOutputFile, debugMode);
        
        System.out.println("Formateo de reporte completado");

    } finally {
        // 4. Limpiar temporal
        if (tempAsciiFile != null && tempAsciiFile.exists()) {
            if (DEBUG || debugMode) {
                System.out.println("DEBUG: Eliminando temporal ASCII: " + tempAsciiFile.getName());
            }
            tempAsciiFile.delete();
        }
    }
}
