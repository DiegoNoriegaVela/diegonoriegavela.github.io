import java.io.*;

/**
 * MipConfig - Configuracion centralizada del sistema MIP
 * 
 * Carga y almacena configuracion desde mipmanager.ini.
 * Usada por MipManager y potencialmente otros componentes.
 */
public class MipConfig {
    
    public String miplog = null;
    public String autoNameReceive = null;
    public int dataChunk = 1014;      // Tamaño máximo de bloque (default Mastercard)
    public int timeout = 20000;        // Timeout I/O en milisegundos
    public int maxAttempts = 99;       // Intentos máximos de búsqueda
    
    private static final boolean DEBUG = Boolean.getBoolean("mip.debug");
    
    /**
     * Carga configuracion desde mipmanager.ini
     * 
     * @return Objeto MipConfig con valores cargados
     */
    public static MipConfig load() {
        MipConfig cfg = new MipConfig();
        
        File iniFile = new File("mipmanager.ini");
        if (!iniFile.exists()) {
            if (DEBUG) {
                System.out.println("DEBUG: mipmanager.ini no encontrado");
            }
            return cfg;
        }
        
        try (BufferedReader reader = new BufferedReader(new FileReader(iniFile))) {
            String line;
            boolean inGeneralSection = false;
            
            while ((line = reader.readLine()) != null) {
                line = line.trim();
                
                if (line.isEmpty() || line.startsWith("#") || line.startsWith(";")) {
                    continue;
                }
                
                if (line.equals("[GENERAL]")) {
                    inGeneralSection = true;
                    continue;
                }
                
                if (line.startsWith("[") && line.endsWith("]")) {
                    inGeneralSection = false;
                    continue;
                }
                
                if (inGeneralSection && line.contains("=")) {
                    int eqIdx = line.indexOf('=');
                    String key = line.substring(0, eqIdx).trim().toLowerCase();
                    String value = line.substring(eqIdx + 1).trim();
                    
                    if (key.equals("miplog")) {
                        cfg.miplog = value;
                    } else if (key.equals("autonamereceive")) {
                        cfg.autoNameReceive = value;
                    } else if (key.equals("datachunk")) {
                        try {
                            cfg.dataChunk = Integer.parseInt(value);
                        } catch (NumberFormatException e) {
                            System.err.println("ADVERTENCIA: datachunk invalido, usando default: " + cfg.dataChunk);
                        }
                    } else if (key.equals("timeout")) {
                        try {
                            cfg.timeout = Integer.parseInt(value);
                        } catch (NumberFormatException e) {
                            System.err.println("ADVERTENCIA: timeout invalido, usando default: " + cfg.timeout);
                        }
                    } else if (key.equals("maxattempts")) {
                        try {
                            cfg.maxAttempts = Integer.parseInt(value);
                        } catch (NumberFormatException e) {
                            System.err.println("ADVERTENCIA: maxattempts invalido, usando default: " + cfg.maxAttempts);
                        }
                    }
                }
            }
            
            if (DEBUG) {
                System.out.println("DEBUG: Configuracion cargada:");
                System.out.println("  miplog=" + cfg.miplog);
                System.out.println("  autoNameReceive=" + cfg.autoNameReceive);
                System.out.println("  dataChunk=" + cfg.dataChunk);
                System.out.println("  timeout=" + cfg.timeout);
                System.out.println("  maxAttempts=" + cfg.maxAttempts);
            }
            
        } catch (IOException e) {
            System.err.println("ADVERTENCIA: Error leyendo mipmanager.ini: " + e.getMessage());
        }
        
        return cfg;
    }
}
