#!/bin/bash
# ============================================================
# Script de compilacion para mipmgr-1.0.0.jar
# ============================================================
# 
# USO:
#   ./build.sh
#
# ESTRUCTURA ESPERADA:
#   /WC_MC/MIPJAR/
#   ├── src/
#   │   └── com/scotiabank/mip/
#   │       ├── MipManager.java
#   │       ├── MipFileTransfer.java
#   │       └── IpmConverter.java
#   ├── target/
#   ├── MANIFEST.MF
#   ├── mipmanager.ini
#   └── build.sh
#
# SALIDA:
#   /WC_MC/MIPJAR/target/mipmgr-1.0.0.jar
#
# ============================================================

# Directorio base (donde esta este script)
BASE_DIR="$(cd "$(dirname "$0")" && pwd)"
SRC_DIR="$BASE_DIR/src"
TARGET_DIR="$BASE_DIR/target"
CLASSES_DIR="$TARGET_DIR/classes"
JAR_NAME="mipmgr-1.0.0.jar"

echo "============================================================"
echo "Compilando MIP Manager v1.0.0"
echo "============================================================"
echo "Directorio base: $BASE_DIR"
echo ""

# Limpiar compilacion anterior
echo "[1/4] Limpiando compilacion anterior..."
rm -rf "$CLASSES_DIR"
rm -f "$TARGET_DIR/$JAR_NAME"
mkdir -p "$CLASSES_DIR"

# Compilar fuentes
echo "[2/4] Compilando fuentes Java..."
javac -d "$CLASSES_DIR" \
    "$SRC_DIR/com/scotiabank/mip/MipManager.java" \
    "$SRC_DIR/com/scotiabank/mip/MipFileTransfer.java" \
    "$SRC_DIR/com/scotiabank/mip/IpmConverter.java"

if [ $? -ne 0 ]; then
    echo "ERROR: Fallo la compilacion"
    exit 1
fi
echo "  Compilacion exitosa"

# Crear JAR
echo "[3/4] Creando archivo JAR..."
jar cfm "$TARGET_DIR/$JAR_NAME" "$BASE_DIR/MANIFEST.MF" -C "$CLASSES_DIR" .

if [ $? -ne 0 ]; then
    echo "ERROR: Fallo la creacion del JAR"
    exit 1
fi
echo "  JAR creado: $TARGET_DIR/$JAR_NAME"

# Copiar mipmanager.ini al target
echo "[4/4] Copiando archivos de configuracion..."
cp "$BASE_DIR/mipmanager.ini" "$TARGET_DIR/"
echo "  mipmanager.ini copiado"

# Limpiar clases temporales
rm -rf "$CLASSES_DIR"

echo ""
echo "============================================================"
echo "COMPILACION COMPLETADA"
echo "============================================================"
echo "JAR generado: $TARGET_DIR/$JAR_NAME"
echo "Config      : $TARGET_DIR/mipmanager.ini"
echo ""
echo "Para usar:"
echo "  java -jar $TARGET_DIR/$JAR_NAME --help"
echo "============================================================"
